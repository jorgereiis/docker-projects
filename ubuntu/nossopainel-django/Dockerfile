FROM ubuntu:20.04

ENV PORT=8001

# Define o frontend como nÃ£o interativo e configura o timezone
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=America/Recife

# Instala as dependÃªncias
RUN apt-get update && apt-get install -y \
    python3-pip python3-dev libpq-dev wget git tzdata

WORKDIR /home/django

# Clona o repositÃ³rio do projeto
RUN git clone https://github.com/jorgereiis/nossopainelgestao.git /home/django/app

# Copiar arquivos essenciais para o projeto
#COPY ./.env /home/django/app
#COPY ./database/db.sqlite3 /home/django/app

RUN mkdir /home/django/app/logs
RUN touch /home/django/app/logs/error.log
RUN mkdir -p /home/django/app/logs/Scheduler

# Define o diretÃ³rio de trabalho e instala os requisitos
WORKDIR /home/django/app
RUN pip3 install --default-timeout=120 --no-cache-dir -r requirements.txt

# ExpÃµe a porta para o servidor
EXPOSE 8001

# Faz as migraÃ§Ãµes e roda o servidor
#CMD ["sh", "-c", "python3 manage.py makemigrations && python3 manage.py migrate && python3 manage.py collectstatic --noinput && gunicorn --bind 0.0.0.0:8001 setup.wsgi:application"]
#CMD ["sh", "-c", "python3 manage.py makemigrations --merge && python3 manage.py migrate && python3 manage.py collectstatic --noinput && python3 manage.py runserver 0.0.0.0:8001"]

# ConfiguraÃ§Ã£o do supervisord
RUN echo '[supervisord]\n\
nodaemon=true\n\
logfile=/var/log/supervisor/supervisord.log\n\
pidfile=/var/run/supervisord.pid\n\
loglevel=info\n\
\n\
[program:gunicorn]\n\
command=gunicorn setup.wsgi:application --bind 0.0.0.0:8001 --workers 3 --threads 2 --worker-class sync --timeout 120 --max-requests 1000 --max-requests-jitter 50 --access-logfile - --error-logfile - --log-level info --name nossopainel-django\n\
directory=/home/django/app\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
priority=1\n\
startsecs=10\n\
stopwaitsecs=30\n\
\n\
[program:agendamentos]\n\
command=python3 scripts/agendamentos.py\n\
directory=/home/django/app\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/home/django/app/logs/Scheduler/agendamentos_stdout.log\n\
stderr_logfile=/home/django/app/logs/Scheduler/agendamentos_stderr.log\n\
stdout_logfile_maxbytes=10MB\n\
stderr_logfile_maxbytes=10MB\n\
stdout_logfile_backups=3\n\
stderr_logfile_backups=3\n\
priority=2\n\
startsecs=10\n\
stopwaitsecs=60\n\
killasgroup=true\n\
stopasgroup=true\n\
' > /etc/supervisor/conf.d/django.conf

# Script de inicializaÃ§Ã£o
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Iniciando aplicaÃ§Ã£o Django em PRODUÃ‡ÃƒO..."\n\
echo "================================================"\n\
\n\
# Verificar variÃ¡veis crÃ­ticas\n\
if [ "$DEBUG" = "True" ]; then\n\
    echo "âš ï¸  WARNING: DEBUG=True detectado em produÃ§Ã£o!"\n\
    echo "   Configure DEBUG=False no .env"\n\
fi\n\
\n\
# Criar migrations\n\
echo "ðŸ“¦ Criando migrations..."\n\
python3 manage.py makemigrations --merge || {\n\
    echo "âš ï¸  Aviso: Problema ao criar migrations (continuando...)"\n\
}\n\
\n\
echo "ðŸ“¦ Aplicando migrations do banco de dados..."\n\
python3 manage.py migrate --noinput || {\n\
    echo "âŒ Erro ao aplicar migrations!"\n\
    exit 1\n\
}\n\
\n\
# Coletar arquivos estÃ¡ticos\n\
echo "ðŸ“ Coletando arquivos estÃ¡ticos..."\n\
python3 manage.py collectstatic --noinput --clear || {\n\
    echo "âŒ Erro ao coletar arquivos estÃ¡ticos!"\n\
    exit 1\n\
}\n\
\n\
echo ""\n\
echo "âœ… Inicializando serviÃ§os com Supervisor..."\n\
echo "   ðŸ“¡ Gunicorn:"\n\
echo "      â€¢ Workers: 3"\n\
echo "      â€¢ Threads por worker: 2"\n\
echo "      â€¢ Bind: 0.0.0.0:8001"\n\
echo "      â€¢ Timeout: 120s"\n\
echo "   â° Agendamentos (scripts/agendamentos.py):"\n\
echo "      â€¢ 08:00 - GP Futebol"\n\
echo "      â€¢ 10:00 - GP Vendas (manhÃ£)"\n\
echo "      â€¢ 12:00 - Scheduled Tasks"\n\
echo "      â€¢ 17:00 - Mensalidades Canceladas"\n\
echo "      â€¢ 20:00 - GP Vendas (noite)"\n\
echo "      â€¢ 23:00 - Telegram Connection"\n\
echo "      â€¢ 23:50 - Upload Telegram"\n\
echo "      â€¢ A cada 60min - Backup DB"\n\
echo "      â€¢ A cada 1min - Envios Agendados"\n\
echo "   ðŸ“‹ Logs:"\n\
echo "      â€¢ Gunicorn: stdout/stderr"\n\
echo "      â€¢ Agendamentos: logs/Scheduler/"\n\
echo "      â€¢ Supervisor: /var/log/supervisor/"\n\
echo "================================================"\n\
echo ""\n\
\n\
# Iniciar Supervisor\n\
exec /usr/bin/supervisord -c /etc/supervisor/supervisord.conf\n\
' > /home/django/app/start.sh && chmod +x /home/django/app/start.sh

CMD ["/home/django/app/start.sh"]