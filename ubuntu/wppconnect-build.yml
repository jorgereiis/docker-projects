# ============================================
# WPPConnect + Nginx - Nosso Painel Gest√£o
# SERVIDOR 2: WPPConnect (WhatsApp API)
# ============================================

services:

  # ==========================================
  # WPPCONNECT SERVER - WhatsApp API
  # ==========================================
  wppconnect-server:
    build:
      context: ./wppconnect-server
      dockerfile: Dockerfile
    image: wppconnect-server
    container_name: wppconnect-server
    hostname: wppconnect-server
    entrypoint: docker-entrypoint.sh yarn dev

    networks:
      - public-network

    volumes:
      - ./wppconnect-server/backups:/home/node/app/backups
      - ./wppconnect-server/tokens:/home/node/app/tokens
      - ./wppconnect-server/sessions:/home/node/app/sessions

    environment:
      - NODE_ENV=production
      - TZ=America/Recife

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21465/api/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    tty: true
    restart: always

  # ==========================================
  # NGINX - Reverse Proxy para WPPConnect
  # ==========================================
  wppconnect-nginx:
    build:
      context: ./wppconnect-nginx
      dockerfile: Dockerfile
    container_name: wppconnect-nginx
    hostname: wppconnect-nginx
    entrypoint: nginx -g "daemon off;"

    # Depende do WPPConnect estar rodando
    depends_on:
      wppconnect-server:
        condition: service_healthy

    ports:
      - "80:80"

    networks:
      - public-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    tty: true
    restart: always

# ============================================
# REDES
# ============================================
networks:
  public-network:
    driver: bridge
